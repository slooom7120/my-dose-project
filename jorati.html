<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDose</title>
    
    <meta name="theme-color" content="#ffffff"/>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            /* (تعريف الألوان - الوضع الفاتح) */
            --bg-color: #f4f7f6;
            --bg-secondary-color: #ffffff;
            --text-color: #333;
            --text-color-secondary: #555;
            --border-color: #ddd;
            --primary-color: #007bff;
            --primary-color-hover: #0056b3;
            --shadow-color: rgba(0,0,0,0.05);
            --pink-light-bg: #fdf2f8; /* (جديد) لون وردي فاتح مستوحى من أمومة */
            --pink-dark-text: #e11d48; /* (جديد) لون وردي داكن */
        }
        
        body.dark-mode {
            --bg-color: #121212;
            --bg-secondary-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-color-secondary: #a0a0a0;
            --border-color: #444;
            --primary-color: #0d8eff;
            --primary-color-hover: #3a9eff;
            --shadow-color: rgba(255,255,255,0.05);
            --pink-light-bg: #3b1f2b;
            --pink-dark-text: #fda4af;
        }

        /* === إعدادات الصفحة العامة === */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* === شريط التنقل العلوي === */
        .navbar {
            background-color: var(--bg-secondary-color);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
            position: sticky; top: 0; z-index: 1000;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .navbar-container {
            max-width: 900px; margin: 0 auto; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); text-decoration: none; }
        .nav-links { display: flex; align-items: center; } 
        .nav-links button {
            background: none; border: none; font-size: 1rem; font-weight: 600;
            color: var(--text-color-secondary);
            margin-right: 15px; cursor: pointer; padding: 10px 5px;
            border-bottom: 3px solid transparent; transition: all 0.2s ease;
        }
        .nav-links button i { margin-left: 8px; }
        .nav-links button:hover { color: var(--primary-color-hover); }
        .nav-links button.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        
        .dark-mode-toggle {
            font-size: 1.2rem;
            color: var(--text-color-secondary);
            cursor: pointer;
            background: none; border: none;
            padding: 5px 10px;
        }
        .dark-mode-toggle:hover { color: var(--primary-color); }

        /* حاوية التطبيق الرئيسية */
        .app-container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .screen { display: none; }
        .screen.active { display: block; }

        /* === تصميم شاشة "جرعاتي" === */
        .header { text-align: center; margin-bottom: 30px; }
        .header h2 { margin: 0; font-size: 1.8rem; }
        .header .date { font-size: 1.2rem; color: var(--text-color-secondary); }
        .streak-counter {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ff9800; 
            margin-top: 15px;
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
        }
        .doses-section-title { font-size: 1.5rem; font-weight: 600; color: #005a8d; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        body.dark-mode .doses-section-title { color: #0d8eff; border-bottom: 2px solid var(--border-color); }
        .dose-card {
            background-color: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            padding: 20px; margin-bottom: 15px; transition: all 0.3s ease;
        }
        .dose-card .time { font-size: 1.7rem; font-weight: 700; color: #005a8d; margin-bottom: 10px; }
        body.dark-mode .dose-card .time { color: #0d8eff; }
        .dose-card .med-name { font-size: 1.4rem; font-weight: 600; margin: 0 0 5px 0; }
        .dose-card .dosage { font-size: 1.1rem; color: var(--text-color-secondary); margin-bottom: 20px; }
        
        .btn { display: inline-block; width: auto; padding: 15px 20px; font-size: 1.1rem; font-weight: 700; text-align: center; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease; }
        .btn-full-width { width: 100%; box-sizing: border-box; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-color-hover); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        
        .dose-card.completed { background-color: #28a74533; border-left: 6px solid #28a745; }
        .status-badge { font-size: 1.3rem; font-weight: 700; color: #28a745; text-align: center; padding: 10px 0; }
        
        /* === تصميم شاشة "إضافة دواء" === */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-color); }
        .form-group input,
        .form-group select,
        .form-group textarea { /* (جديد) إضافة textarea */
            width: 100%; padding: 12px; font-size: 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary-color);
            color: var(--text-color);
            border-radius: 8px; box-sizing: border-box;
            font-family: inherit; /* لتوحيد الخط */
        }
        body.dark-mode .form-group input::placeholder { color: #777; }
        
        .btn-submit { background-color: #28a745; color: white; }
        .btn-submit:hover { background-color: #218838; }
        .time-input-group { display: none; padding-right: 20px; border-right: 3px solid var(--primary-color); margin-top: 15px; }

        /* === تصميم شاشة "أدويتي" === */
        .my-med-card {
            display: flex; align-items: center; justify-content: space-between;
            background-color: var(--bg-secondary-color);
            border-radius: 10px; box-shadow: 0 2px 5px var(--shadow-color);
            padding: 15px 20px; margin-bottom: 10px;
        }
        .my-med-info { flex-grow: 1; }
        .my-med-name { font-size: 1.3rem; font-weight: 600; display: block; }
        .my-med-remaining { font-size: 0.9rem; color: var(--text-color-secondary); margin-bottom: 10px; display: block; }
        .progress-bar-container { width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; }
        body.dark-mode .progress-bar-container { background-color: #333; }
        .progress-bar-inner { height: 100%; background-color: var(--primary-color); border-radius: 4px; transition: width 0.5s ease; }
        
        .my-med-actions { display: flex; align-items: center; margin-right: 15px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.3rem; padding: 8px; margin: 0 5px; transition: color 0.2s ease; }
        .icon-btn.edit { color: var(--primary-color); }
        .icon-btn.edit:hover { color: var(--primary-color-hover); }
        .icon-btn.delete { color: #dc3545; }
        .icon-btn.delete:hover { color: #c82333; }
        .icon-btn.refill { color: #28a745; }
        .icon-btn.refill:hover { color: #218838; }
        
        .placeholder-message { text-align: center; color: var(--text-color-secondary); padding: 30px; font-size: 1.1rem; display: none; }
        
        /* === تصميم شاشة السجل === */
        .log-entry {
            display: flex; align-items: center;
            background-color: var(--bg-secondary-color);
            padding: 15px; border-bottom: 1px solid var(--border-color);
        }
        .log-icon { font-size: 1.5rem; color: #28a745; margin-left: 15px; }
        .log-details { flex-grow: 1; }
        .log-title { font-size: 1.1rem; font-weight: 600; }
        .log-time { font-size: 0.9rem; color: var(--text-color-secondary); }
        .export-btn-container { text-align: center; margin: 20px 0; }
        
        /* === (جديد) تصميم الصفحات التعريفية (عن، تواصل) === */
        .static-page-header {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 20px;
        }
        .static-page-subheader {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-color-secondary);
            margin-bottom: 40px;
        }
        /* تصميم بطاقات الخدمات (مثل أمومة) */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* شبكة مرنة */
            gap: 20px;
            margin-top: 30px;
        }
        .feature-card {
            background-color: var(--bg-secondary-color);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px); /* تأثير رفع عند المرور */
            box-shadow: 0 6px 15px var(--shadow-color);
        }
        .feature-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        .feature-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .feature-description {
            font-size: 1rem;
            color: var(--text-color-secondary);
        }
        /* تصميم بطاقات التواصل (مثل أمومة) */
        .contact-card {
            background-color: var(--pink-light-bg);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .contact-card .feature-icon {
            color: var(--pink-dark-text);
        }
        .contact-card .feature-title {
            color: var(--text-color);
        }
        .contact-card .feature-description {
            color: var(--text-color-secondary);
            font-weight: 600;
        }

        /* === التذييل السفلي === */
        .site-footer {
            background-color: #333;
            color: #aaa;
            text-align: center; padding: 20px;
            margin-top: 40px; border-top: 1px solid #444;
        }
        body.dark-mode .site-footer { background-color: #1e1e1e; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="logo">MyDose 🩺</a>
            <div class="nav-links">
                <button class="icon-btn dark-mode-toggle" onclick="toggleDarkMode()" title="تبديل الوضع">
                    <i class="fas fa-moon"></i>
                </button>
                
                <button class="nav-btn active" onclick="showScreen('screen-home', this)">
                    <i class="fas fa-home"></i> جرعاتي
                </button>
                <button class="nav-btn" onclick="showScreen('screen-my-meds', this)">
                    <i class="fas fa-pills"></i> أدويتي
                </button>
                <button class="nav-btn" onclick="showScreen('screen-log', this)">
                    <i class="fas fa-history"></i> السجل
                </button>
                <button class="nav-btn" onclick="showScreen('screen-add', this)">
                    <i class="fas fa-plus"></i> إضافة دواء
                </button>
                
                <button class="nav-btn" onclick="showScreen('screen-about', this)">
                    <i class="fas fa-info-circle"></i> عن MyDose
                </button>
                <button class="nav-btn" onclick="showScreen('screen-contact', this)">
                    <i class="fas fa-envelope"></i> تواصل معنا
                </button>
            </div>
        </div>
    </nav>

    <div class="app-container">
        
        <main id="screen-home" class="screen active">
             <header class="header">
                <h2>أهلاً بك، محمد</h2>
                <p class="date" id="current-date">...</p>
                <div class="streak-counter" id="streak-counter-display">
                    🔥 0 أيام التزام!
                </div>
            </header>
            <h3 class="doses-section-title">الجرعات القادمة (اليوم)</h3>
            <p id="home-placeholder" class="placeholder-message">
                لا توجد جرعات مجدولة لهذا اليوم.
            </p>
            <div class="doses-list" id="today-doses-list">
                </div>
        </main>

        <main id="screen-add" class="screen">
             <h3 class="doses-section-title" id="add-med-title">إضافة دواء جديد</h3>
            <form id="add-med-form">
                <input type="hidden" id="med-edit-id">
                <div class="form-group"><label for="med-name-input">اسم الدواء:</label><input type="text" id="med-name-input" placeholder="مثال: بنادول" required></div>
                <div class="form-group"><label for="med-total-input">الكمية الإجمالية:</label><input type="number" id="med-total-input" placeholder="مثال: 30" required></div>
                <div class="form-group"><label for="med-times-select">عدد المرات يومياً:</label><select id="med-times-select" onchange="updateDoseTimes(this.value)"><option value="0">عند الحاجة</option><option value="1">مرة واحدة</option><option value="2">مرتين</option><option value="3">3 مرات</option></select></div>
                <div id="time-group-1" class="form-group time-input-group"><label for="med-time1-input">وقت التنبيه الأول:</label><input type="time" id="med-time1-input"></div>
                <div id="time-group-2" class="form-group time-input-group"><label for="med-time2-input">وقت التنبيه الثاني:</label><input type="time" id="med-time2-input"></div>
                <div id="time-group-3" class="form-group time-input-group"><label for="med-time3-input">وقت التنبيه الثالث:</label><input type="time" id="med-time3-input"></div>
                <button type="button" class="btn btn-submit btn-full-width" id="save-btn">حفظ الدواء</button>
                <button type="button" class="btn btn-secondary btn-full-width" id="cancel-edit-btn" onclick="resetForm()" style="display:none; margin-top: 10px;">إلغاء التعديل</button>
            </form>
        </main>
        
        <main id="screen-my-meds" class="screen">
            <h3 class="doses-section-title">خزانة الأدوية</h3>
            <div class="export-btn-container">
                <button class="btn btn-secondary" onclick="exportReport()">
                    <i class="fas fa-print"></i> طباعة/تصدير تقرير للطبيب
                </button>
            </div>
            <p id="my-meds-placeholder" class="placeholder-message">
                لا توجد أدوية حالياً.
            </p>
            <div id="my-meds-list-container">
                </div>
        </main>
        
        <main id="screen-log" class="screen">
            <h3 class="doses-section-title">سجل الجرعات المأخوذة</h3>
            <p id="log-placeholder" class="placeholder-message">
                لم يتم أخذ أي جرعات بعد.
            </p>
            <div id="log-list-container">
                </div>
        </main>
        
        <main id="screen-about" class="screen">
            <h1 class="static-page-header">عن MyDose</h1>
            <p class="static-page-subheader">
                مساعدك الذكي لتنظيم أدويتك وتذكيرك بمواعيدك بكل سهولة.
            </p>
            
            <h3 class="doses-section-title">خدماتنا</h3>
            
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-bell"></i></div>
                    <h4 class="feature-title">تذكير ذكي</h4>
                    <p class="feature-description">إشعارات وتنبيهات فورية عند حلول وقت الجرعة لضمان عدم نسيانها.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-pills"></i></div>
                    <h4 class="feature-title">إدارة المخزون</h4>
                    <p class="feature-description">تتبع الكميات المتبقية من أدويتك، مع تنبيهات عند قرب النفاذ.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-file-medical"></i></div>
                    <h4 class="feature-title">سجل وتقارير</h4>
                    <p class="feature-description">سجل كامل بجميع الجرعات المأخوذة، مع إمكانية طباعة تقرير للطبيب.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-fire"></i></div>
                    <h4 class="feature-title">نظام الالتزام</h4>
                    <p class="feature-description">نظام تحفيزي (Gamification) لمساعدتك على بناء عادة يومية منتظمة.</p>
                </div>
            </div>
        </main>
        
        <main id="screen-contact" class="screen">
            <h1 class="static-page-header">تواصل معنا</h1>
            <p class="static-page-subheader">
                نحن هنا للمساعدة. أرسل لنا استفسارك أو اقتراحك.
            </p>
            
            <div class="features-grid">
                <div class="contact-card">
                    <div class="feature-icon"><i class="fas fa-envelope"></i></div>
                    <h4 class="feature-title">البريد الإلكتروني</h4>
                    <p class="feature-description">support@mydose.app</p>
                </div>
                <div class="contact-card">
                    <div class="feature-icon"><i class="fas fa-phone"></i></div>
                    <h4 class="feature-title">الدعم الفني</h4>
                    <p class="feature-description">9200-XXXXX</p>
                </div>
            </div>
            
            <h3 class="doses-section-title" style="margin-top: 40px;">أو أرسل رسالة مباشرة</h3>
            <form onsubmit="alert('تم إرسال رسالتك (تجريبي).'); return false;">
                <div class="form-group">
                    <label for="contact-name">الاسم:</label>
                    <input type="text" id="contact-name" required>
                </div>
                <div class="form-group">
                    <label for="contact-email">البريد الإلكتروني:</label>
                    <input type="email" id="contact-email" required>
                </div>
                <div class="form-group">
                    <label for="contact-message">الرسالة:</label>
                    <textarea id="contact-message" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-full-width">إرسال الرسالة</button>
            </form>
        </main>
        
    </div> <footer class="site-footer">
        <p>© 2025 MyDose. All rights reserved.</p>
    </footer>

    <script>
    
        // === قواعد البيانات المؤقتة ===
        let myMedications = [];
        let doseHistory = [];
        let userStreak = 0;
        let lastStreakDate = ''; 

        // === تشغيل الموقع عند التحميل ===
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            loadTheme(); 
            updateStreakLogic(); 
            
            renderMyMeds(); 
            renderHomeScreen();
            renderDoseLog(); 
            renderStreakCounter(); 
            updateDate();
            
            requestNotificationPermission(); 
            document.getElementById('save-btn').onclick = addOrUpdateMedicine;
        });

        // --- دالة التنقل بين الشاشات ---
        function showScreen(screenId, clickedButton) {
            // (تعديل) التأكد من أن الزر موجود قبل إزالة الكلاس
            const activeNavButton = document.querySelector('.nav-btn.active');
            if (activeNavButton) activeNavButton.classList.remove('active');
            
            // (تعديل) إذا لم يتم تمرير زر (مثل أول تحميل)، ابحث عنه
            if (!clickedButton) {
                 clickedButton = document.querySelector(`.nav-btn[onclick*="'${screenId}'"]`);
            }
            if (clickedButton) clickedButton.classList.add('active');

            if (!screenId.includes('screen-add')) resetForm();
            
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            
            const targetScreen = document.getElementById(screenId);
            targetScreen.classList.add('active');
            
            // تحديث الشاشات عند زيارتها
            if (screenId === 'screen-my-meds') renderMyMeds();
            if (screenId === 'screen-home') renderHomeScreen();
            if (screenId === 'screen-log') renderDoseLog();
        }
    
        // === دوال حفظ وتحميل البيانات (LocalStorage) ===
        function saveData() {
            localStorage.setItem('myDoseData', JSON.stringify(myMedications));
            localStorage.setItem('myDoseHistory', JSON.stringify(doseHistory));
            localStorage.setItem('myDoseStreak', userStreak.toString());
            localStorage.setItem('myDoseLastStreakDate', lastStreakDate);
        }

        function loadData() {
            const savedData = localStorage.getItem('myDoseData');
            if (savedData) myMedications = JSON.parse(savedData);
            
            const savedHistory = localStorage.getItem('myDoseHistory');
            if (savedHistory) doseHistory = JSON.parse(savedHistory);
            
            userStreak = parseInt(localStorage.getItem('myDoseStreak') || '0');
            lastStreakDate = localStorage.getItem('myDoseLastStreakDate') || '';
        }
        
        // === دوال الوضع الليلي ===
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('myDoseTheme', isDark ? 'dark' : 'light');
            const icon = document.querySelector('.dark-mode-toggle i');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        function loadTheme() {
            const theme = localStorage.getItem('myDoseTheme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                document.querySelector('.dark-mode-toggle i').className = 'fas fa-moon';
            }
        }
        
        // --- دالة إظهار حقول الوقت ---
        function updateDoseTimes(value) {
            const times = parseInt(value);
            document.getElementById('time-group-1').style.display = 'none';
            document.getElementById('time-group-2').style.display = 'none';
            document.getElementById('time-group-3').style.display = 'none';
            if (times >= 1) document.getElementById('time-group-1').style.display = 'block';
            if (times >= 2) document.getElementById('time-group-2').style.display = 'block';
            if (times >= 3) document.getElementById('time-group-3').style.display = 'block';
        }

        // === دوال الإضافة والتعديل ===
        function addOrUpdateMedicine() {
            const editId = document.getElementById('med-edit-id').value;
            if (editId) { updateMedicine(editId); } else { addMedicine(); }
        }

        function addMedicine() {
            const medName = document.getElementById('med-name-input').value;
            const medTotal = document.getElementById('med-total-input').value;
            if (medName === '' || medTotal === '') { alert('الرجاء تعبئة اسم الدواء والكمية الإجمالية.'); return; }
            const newMed = {
                id: Date.now(), name: medName, total: parseInt(medTotal), remaining: parseInt(medTotal),
                timesPerDay: parseInt(document.getElementById('med-times-select').value),
                time1: document.getElementById('med-time1-input').value,
                time2: document.getElementById('med-time2-input').value,
                time3: document.getElementById('med-time3-input').value
            };
            myMedications.push(newMed);
            saveData();
            renderMyMeds();
            resetForm();
            alert('تمت إضافة الدواء بنجاح!');
            showScreen('screen-my-meds');
        }

        function showEditForm(medId) {
            const med = myMedications.find(m => m.id === medId);
            if (!med) return;
            document.getElementById('med-edit-id').value = med.id;
            document.getElementById('med-name-input').value = med.name;
            document.getElementById('med-total-input').value = med.total;
            document.getElementById('med-times-select').value = med.timesPerDay;
            updateDoseTimes(med.timesPerDay);
            document.getElementById('med-time1-input').value = med.time1 || '';
            document.getElementById('med-time2-input').value = med.time2 || '';
            document.getElementById('med-time3-input').value = med.time3 || '';
            document.getElementById('add-med-title').innerText = 'تعديل الدواء';
            document.getElementById('save-btn').innerText = 'حفظ التعديلات';
            document.getElementById('cancel-edit-btn').style.display = 'block';
            showScreen('screen-add');
        }

        function updateMedicine(medId) {
            const medIndex = myMedications.findIndex(m => m.id === parseInt(medId));
            if (medIndex === -1) return;
            const medName = document.getElementById('med-name-input').value;
            const medTotal = document.getElementById('med-total-input').value;
            if (medName === '' || medTotal === '') { alert('الرجاء تعبئة اسم الدواء والكمية الإجمالية.'); return; }
            const oldTotal = myMedications[medIndex].total;
            const remaining = myMedications[medIndex].remaining;
            const newRemaining = remaining + (parseInt(medTotal) - oldTotal);
            const updatedMed = {
                id: parseInt(medId), name: medName, total: parseInt(medTotal), remaining: newRemaining < 0 ? 0 : newRemaining,
                timesPerDay: parseInt(document.getElementById('med-times-select').value),
                time1: document.getElementById('med-time1-input').value,
                time2: document.getElementById('med-time2-input').value,
                time3: document.getElementById('med-time3-input').value
            };
            myMedications[medIndex] = updatedMed;
            saveData();
            renderMyMeds();
            renderHomeScreen();
            resetForm();
            alert('تم تحديث الدواء بنجاح!');
            showScreen('screen-my-meds');
        }
        
        function resetForm() {
            document.getElementById('add-med-form').reset();
            document.getElementById('med-edit-id').value = ''; 
            document.getElementById('add-med-title').innerText = 'إضافة دواء جديد';
            document.getElementById('save-btn').innerText = 'حفظ الدواء';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            updateDoseTimes('0');
        }

        // === دالة عرض شاشة "أدويتي" ===
        function renderMyMeds() {
            const container = document.getElementById('my-meds-list-container');
            const placeholder = document.getElementById('my-meds-placeholder');
            container.innerHTML = ''; 
            if (myMedications.length === 0) {
                placeholder.style.display = 'block'; 
            } else {
                placeholder.style.display = 'none'; 
                myMedications.forEach(med => {
                    const percentage = (med.total > 0) ? (med.remaining / med.total) * 100 : 0;
                    const barColor = percentage < 20 ? '#dc3545' : 'var(--primary-color)';
                    const cardHTML = `
                        <div class="my-med-card" id="med-card-${med.id}">
                            <div class="my-med-info">
                                <span class="my-med-name">${med.name}</span>
                                <span class="my-med-remaining">${med.remaining} / ${med.total} حبة متبقية</span>
                                <div class="progress-bar-container"><div class="progress-bar-inner" style="width: ${percentage}%; background-color: ${barColor};"></div></div>
                            </div>
                            <div class="my-med-actions">
                                <button class="icon-btn refill" onclick="refillMedicine(${med.id})" title="إعادة تعبئة"><i class="fas fa-plus-circle"></i></button>
                                <button class="icon-btn edit" onclick="showEditForm(${med.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                <button class="icon-btn delete" onclick="deleteMedicine(${med.id})" title="حذف"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    container.innerHTML += cardHTML;
                });
            }
        }
        
        // === دالة إعادة التعبئة ===
        function refillMedicine(medId) {
            const med = myMedications.find(m => m.id === medId);
            if (!med) return;
            const refillAmountStr = prompt(`إعادة تعبئة دواء "${med.name}"\nكم حبة أضفت إلى المخزون؟ (الكمية الحالية: ${med.total})`);
            
            if (refillAmountStr && !isNaN(refillAmountStr) && parseInt(refillAmountStr) > 0) {
                const amount = parseInt(refillAmountStr);
                med.remaining += amount; 
                med.total += amount; // (تعديل) الخيار الأفضل هو زيادة الإجمالي أيضاً
                saveData();
                renderMyMeds();
                alert('تمت إعادة التعبئة بنجاح!');
            }
        }
        
        // === دالة حذف دواء ===
        function deleteMedicine(medId) {
            if (confirm('هل أنت متأكد من حذف هذا الدواء؟\nسيتم حذف سجل الجرعات الخاص به أيضاً.')) {
                myMedications = myMedications.filter(med => med.id !== medId);
                doseHistory = doseHistory.filter(log => log.medId !== medId);
                saveData(); 
                renderMyMeds();
                renderHomeScreen();
                renderDoseLog();
            }
        }
        
        // === دالة عرض الشاشة الرئيسية ===
        function renderHomeScreen() {
            const container = document.getElementById('today-doses-list');
            const placeholder = document.getElementById('home-placeholder');
            container.innerHTML = '';
            let dosesForToday = getTodayDoses(); 
            
            if (dosesForToday.length === 0) {
                placeholder.style.display = 'block';
            } else {
                placeholder.style.display = 'none';
                dosesForToday.forEach(dose => {
                    const [hours, minutes] = dose.time.split(':');
                    const doseTime = new Date();
                    doseTime.setHours(hours, minutes, 0, 0);
                    const msUntilDose = doseTime.getTime() - new Date().getTime();

                    if (msUntilDose > 0 && !dose.taken) {
                        setTimeout(() => {
                            showNotification(`حان وقت الجرعة!`, `لا تنسى أخذ ${dose.name} (${dose.dosage})`);
                        }, msUntilDose);
                    }
                    
                    let cardHTML;
                    if (dose.taken) {
                        cardHTML = `<div class="dose-card completed"><div class="time">${dose.time}</div><h4 class="med-name">${dose.name}</h4><p class="dosage">${dose.dosage}</p><div class="status-badge">✅ تم أخذها اليوم</div></div>`;
                    } else {
                        cardHTML = `
                        <div class="dose-card" id="dose-card-${dose.doseId}">
                            <div class="time">${dose.time}</div><h4 class="med-name">${dose.name}</h4><p class="dosage">${dose.dosage}</p>
                            <button class="btn btn-primary btn-full-width" onclick="markAsDone(this, ${dose.id}, '${dose.doseId}', '${dose.name}', '${dose.time}')">
                                <i class="fas fa-check"></i> تم أخذ الجرعة
                            </button>
                        </div>`;
                    }
                    container.innerHTML += cardHTML;
                });
            }
        }
        
        // === دالة إتمام الجرعة ===
        function markAsDone(buttonElement, medId, doseId, medName, doseTime) {
            const card = buttonElement.closest('.dose-card');
            
            card.classList.add('completed');
            buttonElement.remove();
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-badge';
            statusDiv.innerHTML = '✅ تم أخذها اليوم';
            card.appendChild(statusDiv);
            
            const med = myMedications.find(m => m.id === medId);
            if (med && med.remaining > 0) {
                med.remaining--; 
            }
            
            const logEntry = {
                medId: medId, doseId: doseId, name: medName, time: doseTime,
                date: new Date().toISOString()
            };
            doseHistory.unshift(logEntry);
            
            saveData(); 
            renderMyMeds(); 
            
            checkStreak();
            renderStreakCounter();
        }

        // === دالة عرض شاشة السجل ===
        function renderDoseLog() {
            const container = document.getElementById('log-list-container');
            const placeholder = document.getElementById('log-placeholder');
            container.innerHTML = '';
            if (doseHistory.length === 0) {
                placeholder.style.display = 'block';
            } else {
                placeholder.style.display = 'none';
                doseHistory.forEach(log => {
                    const logDate = new Date(log.date);
                    const formattedDate = logDate.toLocaleDateString('ar-SA', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = logDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                    const logHTML = `<div class="log-entry"><div class="log-icon"><i class="fas fa-check-circle"></i></div><div class="log-details"><span class="log-title">${log.name} (وقت الجدولة: ${log.time})</span><span class="log-time">تم الأخذ في: ${formattedDate} - ${formattedTime}</span></div></div>`;
                    container.innerHTML += logHTML;
                });
            }
        }
        
        // === دالة تصدير التقرير ===
        function exportReport() {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write("<html><head><title>تقرير MyDose</title><style>body{direction: rtl; font-family: Arial, sans-serif;} h1 {text-align: center; color: #005a8d;} h2 {border-bottom: 2px solid #eee; padding-bottom: 5px;} table{width: 100%; border-collapse: collapse; margin-bottom: 20px;} th,td{border: 1px solid #ddd; padding: 8px; text-align: right;} th {background-color: #f4f4f4;}</style></head><body>");
            
            printWindow.document.write(`<h1>تقرير الأدوية - MyDose</h1><p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>`);
            printWindow.document.write("<h2>قائمة الأدوية الحالية</h2><table><tr><th>الدواء</th><th>المتبقي</th><th>الإجمالي</th><th>المواعيد</th></tr>");
            
            myMedications.forEach(med => {
                let times = [med.time1, med.time2, med.time3].filter(Boolean).join(', ') || 'عند الحاجة';
                printWindow.document.write(`<tr><td>${med.name}</td><td>${med.remaining}</td><td>${med.total}</td><td>${times}</td></tr>`);
            });
            printWindow.document.write("</table>");
            
            printWindow.document.write("<h2>آخر 10 جرعات تم أخذها</h2><table><tr><th>الدواء</th><th>تاريخ ووقت الأخذ</th></tr>");
            doseHistory.slice(0, 10).forEach(log => {
                const logDate = new Date(log.date);
                const formattedDateTime = logDate.toLocaleString('ar-SA');
                printWindow.document.write(`<tr><td>${log.name}</td><td>${formattedDateTime}</td></tr>`);
            });
            printWindow.document.write("</table></body></html>");
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // === دوال الإشعارات ===
        function requestNotificationPermission() {
             if (!("Notification" in window)) { console.log("المتصفح لا يدعم الإشعارات"); }
             else if (Notification.permission !== "denied") { Notification.requestPermission(); }
        }
        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/128/3063/3063239.png' });
            }
        }
        
        // === دالة تحديث التاريخ ===
        function updateDate() {
            const dateEl = document.getElementById('current-date');
            const today = new Date();
            const options = { calendar: 'islamic-umalqura', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.innerText = today.toLocaleDateString('ar-SA', options);
        }
        
        // === دوال الالتزام ===
        function renderStreakCounter() {
            document.getElementById('streak-counter-display').innerHTML = `🔥 ${userStreak} أيام التزام!`;
        }
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        function getYesterdayString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toISOString().split('T')[0];
        }
        function updateStreakLogic() {
            const today = getTodayString();
            const yesterday = getYesterdayString();
            if (lastStreakDate !== today && lastStreakDate !== yesterday) {
                userStreak = 0; 
            }
            saveData(); 
        }
        function checkStreak() {
            const today = getTodayString();
            if (lastStreakDate === today) return; 
            const dosesForToday = getTodayDoses();
            if (dosesForToday.length === 0) return;
            const allTaken = dosesForToday.every(dose => dose.taken); 
            if (allTaken) {
                const yesterday = getYesterdayString();
                if (lastStreakDate === yesterday) {
                    userStreak++;
                } else {
                    userStreak = 1;
                }
                lastStreakDate = today; 
                saveData(); 
            }
        }
        function getTodayDoses() {
            let dosesForToday = [];
            const todayDate = new Date().toLocaleDateString();
            
            myMedications.forEach(med => {
                if (med.remaining > 0) {
                    [med.time1, med.time2, med.time3].forEach((time, index) => {
                        if (time) {
                            const doseId = `${med.id}-${time}-${todayDate}`;
                            const isTaken = doseHistory.some(log => log.doseId === doseId);
                            dosesForToday.push({ 
                                time: time, name: med.name, id: med.id, 
                                dosage: `الجرعة ${index + 1}`,
                                taken: isTaken, doseId: doseId
                            });
                        }
                    });
                }
            });
            dosesForToday.sort((a, b) => a.time.localeCompare(b.time));
            return dosesForToday;
        }

    </script>

</body>
</html>